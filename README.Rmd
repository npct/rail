---
output: bookdown::github_document2
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  cache = TRUE,
  collapse = TRUE,
  comment = "#>",
  # eval = FALSE,
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
library(tidyverse)
library(sf)

param_region = "west-yorkshire"
param_min_flow = 100
param_min_flow_rail = 10
```

# Estimating cycling potential to rail stations

<!-- badges: start -->
[![.github/workflows/render-rmarkdown.yaml](https://github.com/npct/rail/actions/workflows/render-rmarkdown.yaml/badge.svg)](https://github.com/npct/rail/actions/workflows/render-rmarkdown.yaml)
<!-- badges: end -->

The goal of this repo is to explore methods for calculating cycling potential to public transport nodes, rail stations in the first instance.

# OD data

The input data consists of origin-destination pairs.
These can be obtained from a range of sources.
We will use open OD data from the 2011 UK Census to demonstrate the methods.
A random sample of OD pairs from the national dataset is shown below.

```{r}
od_england_wales = pct::get_od()
centroids_england_wales = pct::get_centroids_ew() %>% 
  sf::st_transform(4326)
od_england_wales %>% 
  sample_n(3) %>% 
  knitr::kable()
```

```{r}
region = pct::pct_regions %>% 
  filter(region_name == param_region)
centroids_region = centroids_england_wales[region, ]
od_region = od_england_wales %>% 
  filter(geo_code1 %in% centroids_region$msoa11cd)
od_filtered = od_region %>% 
  filter(all >= param_min_flow_rail)
desire_filtered = od::od_to_sf(x = od_filtered, z = centroids_england_wales)
desire_filtered$length_m = sf::st_length(desire_filtered) %>% as.numeric()
desire_rail = desire_filtered %>% 
  filter(train >= param_min_flow_rail)
```

The case study region of West Yorkshire is used to subset the dataset of `r nrow(od_england_wales)` OD pairs to records representing trips originating in the region (`r nrow(od_region)` rows).
In a further subsetting stage only OD pairs with more than a threshold number of trips were kept to focus the analysis on desire lines in which large numbers of people travel by train.
Setting this threshold to `r param_min_flow_rail` people by results in `r nrow(desire_rail)` rows in the case study region.
These rail trips are illustrated in Figure \@ref(fig:simpleraildesire) below.

```{r simpleraildesire, fig.cap="Illustration of major commute desire lines originating in West Yorkshire by any mode (black) and by rail (blue)."}
plot(region$geometry)
plot(centroids_england_wales$geometry, add = TRUE)
plot(centroids_region$geometry, pch = 2, add = TRUE)
plot(desire_filtered$geometry, add = TRUE, lwd = 0.2)
plot(desire_rail$geometry, add = TRUE, col = "blue")
```

# Rail station data

Data on rail station locations was obtained from the [naptan.app.dft.gov.uk](http://naptan.app.dft.gov.uk) website.
The multi-stage trips from home to work via rail stations is shown in Figure \@ref(fig:railsample) below.
This graphic assumes simplistically that the first stage of rail journeys was to the nearest station, that the rail journey went to the station closes to their destination, and that trips involve travelling in a straight line (an assumption we will remove in the next section). 

```{r, eval=FALSE}
u_naptan = "http://naptan.app.dft.gov.uk/DataRequest/Naptan.ashx?format=csv"
f_naptan = basename(u_naptan)
download.file(url = u_naptan, destfile = f_naptan)
unzip(f_naptan)
list.files()
rail_naptan = readr::read_csv("RailReferences.csv")
rail_sf = sf::st_as_sf(rail_naptan, coords = c("Easting", "Northing"), crs = 27700) %>% 
  sf::st_transform(4326)
plot(region$geometry)
sf::write_sf(rail_sf, "rail_stations.geojson")
```

```{r railsample, fig.show='hold', out.width="49%", fig.cap="Illustration of desire lines with high numbers of rail trips, focussing on a sample of 5, assuming straight line travel (left) and assuming trips travel via the nearest station to the origin and destination, showing desire lines from home locations to the nearest stations (right)." }
# plot sample of trips to demo data on
set.seed(7)
desire_sample = desire_rail %>% 
  filter(length_m > 10000) %>% 
  sample_n(3)
desire_sample2 = desire_rail %>% 
  filter(length_m > 10000) %>% 
  filter(!geo_code2 %in% centroids_region$msoa11cd) %>% 
  sample_n(2)

desire_sample = rbind(desire_sample, desire_sample2)
rail_stations = sf::read_sf("rail_stations.geojson")
# calculate straight line routes via stations
desire_rail_via = stplanr::line_via(l = desire_rail, p = rail_stations)
desire_sample_via = stplanr::line_via(l = desire_sample, p = rail_stations)
# sf::st_crs(desire_sample_via$leg_dest) # see https://github.com/ropensci/stplanr/issues/465

plot(region$geometry)
plot(desire_rail$geometry, col = "grey", add = TRUE)
plot(desire_sample$geometry, col = "blue", add = TRUE, lwd = 2)
plot(rail_stations$geometry, add = TRUE)

plot(region$geometry)
plot(desire_rail_via$leg_orig, col = "grey", add = TRUE)
plot(desire_sample_via$leg_orig, col = "green", add = TRUE, lwd = 3)
plot(desire_sample_via$leg_via, col = "red", add = TRUE, lwd = 3)
plot(desire_sample_via$leg_dest, col = "orange", add = TRUE, lwd = 3)
```



# Transit routing



# Discussion
